<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultra Wash Appointment Form</title>
<style>
:root {
  --font-family: 'Open Sans', sans-serif;
  --font-size-label: 14px;
  --font-size-input: 14px;
  --font-size-header: 22px;
  --color-background: #f6f7fa;
  --color-card-bg: #ffffff;
  --color-card-border: #dbdfe7;
  --color-card-shadow: rgba(99, 77, 255, 0.06);
  --color-header: #333;
  --color-label: #555;
  --color-input-border: #ccc;
  --color-input-text: #333;
  --color-focus-border: #5a4cc2;
  --color-btn-bg: #ff6d5a;
  --color-btn-text: #fff;
  --radius: 6px;
  --container-width: 440px;
}
body {
  font-family: var(--font-family);
  background-color: var(--color-background);
  display: flex;
  justify-content: center;
  padding: 32px;
}
form {
  background: var(--color-card-bg);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px var(--color-card-shadow);
  padding: 24px;
  width: var(--container-width);
}
h1 {
  text-align: center;
  font-size: var(--font-size-header);
  color: var(--color-header);
  margin-bottom: 24px;
}
label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: var(--font-size-label);
}
input[type="text"],
input[type="tel"],
input[type="datetime-local"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 10px;
  font-size: var(--font-size-input);
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 16px;
  box-sizing: border-box;
}
input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--color-focus-border);
  box-shadow: 0 0 4px var(--color-focus-border);
}
textarea { resize: vertical; }
button[type="submit"] {
  background-color: var(--color-btn-bg);
  color: var(--color-btn-text);
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: var(--font-size-input);
  cursor: pointer;
  margin-bottom: 16px;
}
button[type="submit"]:hover { background-color: #e05343; }
.note { font-size: 13px; color: #555; margin: 4px 0 16px 0; line-height: 1.4; }
.small-checkbox-label { font-size: 13px; margin-left: 4px; }
#thankYouPopup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#thankYouPopup .popup-content {
  background: white;
  border-radius: 12px;
  padding: 24px 16px;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
#thankYouPopup .checkmark { font-size: 48px; color: #4CAF50; margin-bottom: 16px; }
#thankYouPopup h1 { font-size: 20px; margin-bottom: 12px; color: #222; }
#thankYouPopup p { font-size: 15px; color: #555; line-height: 1.6; margin: 0; }
#thankYouPopup button {
  margin-top: 20px;
  background-color: #ff6d5a;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}
#sameAsPickupWrapper { margin-bottom: 8px; }
.same-as-active { margin-bottom: 40px; }
.pricing-details {
  background-color: #f9f9f9;
  border-left: 4px solid #5a4cc2;
  padding: 10px;
  margin-bottom: 16px;
  border-radius: 4px;
}
.auto-filled {
  background-color: #f0f7ff;
  border-left: 4px solid #4a90e2;
}
.membership-usage {
  background-color: #f8f9fa;
  border-left: 4px solid #4a90e2;
  padding: 15px;
  margin-bottom: 16px;
  border-radius: 4px;
}
.membership-usage h3 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #2c3e50;
  font-size: 16px;
}
</style>
</head>
<body>

<form id="appointmentForm" method="POST" action="https://risetotop.app.n8n.cloud/webhook-test/uw-admin" novalidate>
  <h1>Ultra Wash Appointment</h1>

  <!-- Form Type Selection -->
  <label for="formMode">Form Type</label>
  <select id="formMode" name="formMode" required>
    <option value="" disabled selected>Select Form Type</option>
    <option value="customer">Customer Form</option>
    <option value="update">Update Form</option>
  </select>

  <!-- Customer Form -->
  <div id="customerForm" style="display:none;">
    <label for="name">Full Name</label>
    <input id="name" name="name" type="text" placeholder="First Name, Last Name" />

    <label for="phone">Phone Number</label>
    <input id="phone" name="phone" type="tel" placeholder="+673 8221133 / 8221133" />

    <!-- Service Package Field -->
    <label for="pricingService">Service Package</label>
    <select id="pricingService" name="pricingService">
      <option value="">-- Select Package --</option>
      <option value="membership">Membership</option>
      <option value="jimat">Jimat Cuci Bersama</option>
      <option value="wash">Wash, Dry & Fold</option>
      <option value="folding">Folding</option>
      <option value="ironing">Ironing</option>
    </select>

    <!-- Membership options -->
    <div id="membershipFields" style="display:none;">
      <label for="membershipPlan">Membership Plan</label>
      <select id="membershipPlan" name="membershipPlan">
        <option value="">-- Select Plan --</option>
        <option value="120-12-60">$120 – 12 trips (60kg)</option>
        <option value="100-2-50">$100 – 2x/week (max 50kg, 1 address)</option>
      </select>
    </div>

    <!-- Jimat options -->
    <div id="jimatFields" style="display:none;">
      <label for="jimatPlan">Jimat Cuci Bersama</label>
      <select id="jimatPlan" name="jimatPlan">
        <option value="">-- Select Box --</option>
        <option value="16">$16 / 1 box</option>
        <option value="28">$28 / 2 boxes</option>
        <option value="40">$40 / 4 boxes</option>
      </select>
    </div>

    <!-- Static Price Display (No Live Calculation) -->
    <div class="note"><strong>Price will be calculated after selection</strong></div>

    <label for="service">Service</label>
    <select id="service" name="service">
      <option value="" disabled selected>Select service</option>
      <option value="Self Drop-off & Pick Up">Self Drop-off & Pick Up</option>
      <option value="Pick Up Only">Pick Up Only</option>
      <option value="Delivery Only">Delivery Only</option>
      <option value="Pick Up & Delivery">Pick Up & Delivery</option>
    </select>

    <div id="serviceFields" style="display:none;">
      <div id="singleAddressSection" style="display:none;">
        <label id="singleAddressLabel">Address</label>
        <textarea id="singleAddress" name="singleAddress" placeholder="Enter your Address" rows="3"></textarea>
        <label for="singleMapLink">Map Link</label>
        <input id="singleMapLink" name="singleMapLink" type="text" placeholder="Paste Google Maps link or Coordinates" />
        <label id="singleDateLabel">Date & Time</label>
        <div class="note" id="singleDateNote"></div>
        <input type="datetime-local" id="singleDateTime" name="singleDateTime" />
        <input type="hidden" id="singleDateFormatted" name="singleDateFormatted">
      </div>

      <div id="pickUpDeliverySection" style="display:none;">
        <label>Pick Up Location</label>
        <textarea id="pickupAddress" name="pickupAddress" placeholder="Enter your Address" rows="3"></textarea>
        <label for="pickupMapLink">Map Link</label>
        <input id="pickupMapLink" name="pickupMapLink" type="text" placeholder="Paste Google Maps link" />
        <label>Pick Up Date & Time</label>
        <div class="note">⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
        <input type="datetime-local" id="pickupDate" name="pickupDate" />
        <input type="hidden" id="pickupDateFormatted" name="pickupDateFormatted">

        <label>Delivery Location</label>
        <div id="sameAsPickupWrapper">
          <input type="checkbox" id="sameAsPickup"> 
          <span class="small-checkbox-label">Delivery address same as Pickup</span>
        </div>
        <textarea id="deliveryAddress" name="deliveryAddress" placeholder="Enter your Address" rows="3"></textarea>
        <label for="deliveryMapLink" id="deliveryMapLabel">Map Link</label>
        <input id="deliveryMapLink" name="deliveryMapLink" type="text" placeholder="Paste Google Maps link" />
        <div id="deliveryDateSection" style="display:none;">
          <label>Delivery Date & Time</label>
          <div class="note">⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
          <input type="datetime-local" id="deliveryDate" name="deliveryDate" />
          <input type="hidden" id="deliveryDateFormatted" name="deliveryDateFormatted">
        </div>
      </div>
    </div>
  </div>

  <!-- Update Form (Worker Form) -->
  <div id="updateForm" style="display:none;">
    <label for="customerRef">Customer Reference (Phone/ID)</label>
    <select id="customerRef" name="customerRef" required>
      <option value="" disabled selected>Select Customer</option>
    </select>

    <!-- Hidden Phone Number (for backend only) -->
    <input id="customerPhoneWorker" name="customerPhoneWorker" type="hidden" />

    <label for="mapLinkWorker">Map Link</label>
    <input id="mapLinkWorker" name="mapLinkWorker" type="text" readonly placeholder="Auto-filled from Customer Data" class="auto-filled" />

    <label for="serviceWorker">Service Type</label>
    <input id="serviceWorker" name="serviceWorker" type="text" readonly placeholder="Auto-filled from Customer Data" class="auto-filled" />

    <!-- Hidden Customer Name -->
    <input id="customerNameWorker" name="customerNameWorker" type="hidden" />

    <!-- Service Package Field for Update Form (Readonly) -->
    <label for="pricingServiceUpdate">Service Package</label>
    <input id="pricingServiceUpdateDisplay" name="pricingServiceUpdateDisplay" type="text" readonly class="auto-filled" />
    <input id="pricingServiceUpdate" name="pricingServiceUpdate" type="hidden" />

    <!-- Update Form Pricing Fields -->
    <div id="membershipFieldsUpdate" style="display:none;">
      <label for="membershipPlanUpdate">Membership Plan</label>
      <select id="membershipPlanUpdate" name="membershipPlanUpdate" disabled>
        <option value="">-- Select Plan --</option>
        <option value="120-12-60">$120 – 12 trips (60kg)</option>
        <option value="100-2-50">$100 – 2x/week (max 50kg, 1 address)</option>
      </select>
    </div>

    <div id="jimatFieldsUpdate" style="display:none;">
      <label for="jimatPlanUpdate">Jimat Cuci Bersama</label>
      <select id="jimatPlanUpdate" name="jimatPlanUpdate" disabled>
        <option value="">-- Select Box --</option>
        <option value="16">$16 / 1 box</option>
        <option value="28">$28 / 2 boxes</option>
        <option value="40">$40 / 4 boxes</option>
      </select>
    </div>

    <div id="washFieldsUpdate" style="display:none;">
      <label for="washKgUpdate">Weight (kg)</label>
      <input type="number" id="washKgUpdate" name="washKgUpdate" min="1" step="1" />
    </div>

    <div id="foldingFieldsUpdate" style="display:none;">
      <label for="foldKgUpdate">Weight (kg)</label>
      <input type="number" id="foldKgUpdate" name="foldKgUpdate" min="1" step="1" />
    </div>

    <div id="ironingFieldsUpdate" style="display:none;">
      <label for="ironPcsUpdate">Number of Pieces</label>
      <input type="number" id="ironPcsUpdate" name="ironPcsUpdate" min="1" step="1" />
    </div>

    <!-- Membership Usage Tracking (Only shown for membership customers) -->
    <div id="membershipUsageSection" class="membership-usage" style="display:none;">
      <h3>Membership Usage</h3>
      <label for="tripsUsed">Trips Used</label>
      <input type="number" id="tripsUsed" name="tripsUsed" min="0" step="1" value="1" />
      
      <label for="weightUsed">Weight Used (Kg)</label>
      <input type="number" id="weightUsed" name="weightUsed" min="0" step="0.1" />
      
      <!-- Membership Balance Display -->
      <div id="membershipBalance" style="margin-top: 10px; padding: 10px; background-color: #e8f4fc; border-radius: 4px;">
        <strong>Current Balance:</strong><br>
        <span id="tripsBalance">Trips: --</span><br>
        <span id="weightBalance">Weight: -- kg</span>
      </div>
    </div>

    <!-- Live Calculation for Update Form (Hidden for membership) -->
    <div id="pricingDetailsUpdate" class="pricing-details" style="display:none;">
      <strong>Total Price: <span id="totalPriceUpdate">--</span></strong><br>
      <strong>Price Breakdown: <span id="priceBreakdownUpdate">--</span></strong>
    </div>

    <label for="totalItems">Total Items</label>
    <input id="totalItems" name="totalItems" type="number" min="1" placeholder="Enter total items" />
  </div>

  <button type="submit">Submit</button>
</form>

<div id="thankYouPopup">
  <div class="popup-content">
    <div class="checkmark">✅</div>
    <h1>Thank you!</h1>
    <p>Form has been successfully submitted.<br>Please update accordingly.</p>
    <button onclick="closePopup()">Close</button>
  </div>
</div>

<script>
const formMode = document.getElementById('formMode');
const customerForm = document.getElementById('customerForm');
const updateForm = document.getElementById('updateForm');
const serviceSelect = document.getElementById('service');
const serviceFields = document.getElementById('serviceFields');
const singleAddressSection = document.getElementById('singleAddressSection');
const pickUpDeliverySection = document.getElementById('pickUpDeliverySection');
const sameAsPickup = document.getElementById('sameAsPickup');
const sameAsPickupWrapper = document.getElementById('sameAsPickupWrapper');
const deliveryAddress = document.getElementById('deliveryAddress');
const deliveryMapLink = document.getElementById('deliveryMapLink');
const deliveryMapLabel = document.getElementById('deliveryMapLabel');

// Switch form modes
formMode.addEventListener('change', () => {
  if(formMode.value === 'customer'){
    customerForm.style.display = 'block';
    updateForm.style.display = 'none';
    serviceFields.style.display = 'none';
  } else if(formMode.value === 'update'){
    customerForm.style.display = 'none';
    updateForm.style.display = 'block';
  }
});

// Service selection
serviceSelect.addEventListener('change', () => {
  serviceFields.style.display = 'block';
  if(serviceSelect.value === 'Self Drop-off & Pick Up'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'none';
  } else if(serviceSelect.value === 'Pick Up Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Pick Up Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Delivery Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Delivery Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Pick Up & Delivery'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'block';
    sameAsPickup.checked = false;
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Delivery same as pickup toggle
sameAsPickup.addEventListener('change', () => {
  if(sameAsPickup.checked){
    deliveryAddress.style.display = 'none';
    deliveryMapLink.style.display = 'none';
    deliveryMapLabel.style.display = 'none';
    document.getElementById('deliveryDateSection').style.display = 'none';
    sameAsPickupWrapper.classList.add('same-as-active');
  } else {
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Close popup
function closePopup(){ document.getElementById('thankYouPopup').style.display='none'; }

// Load customer list from Google Apps Script
async function loadCustomers() {
  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec");
    const customers = await response.json();
    const customerRefSelect = document.getElementById("customerRef");

    customers.forEach(cust => {
      let option = document.createElement("option");
      option.value = cust["Customer ID"] || cust["Phone"];
      option.textContent = `${cust["Name"]} (${cust["Customer ID"]})`;
      option.dataset.maplink = cust["Map Link / Coordinates"];
      option.dataset.address = cust["Location Address"];
      option.dataset.service = cust["Service Type"] || "";
      option.dataset.name = cust["Name"];
      option.dataset.phone = cust["Phone"];
      option.dataset.package = cust["Service Package"] || "";
      option.dataset.plan = cust["Plan Details"] || "";
      option.dataset.quantity = cust["Quantity"] || "";
      customerRefSelect.appendChild(option);
    });

    customerRefSelect.addEventListener("change", function() {
      const selectedOption = this.options[this.selectedIndex];
      document.getElementById("mapLinkWorker").value = selectedOption.dataset.maplink || "";
      document.getElementById("serviceWorker").value = selectedOption.dataset.service || "";
      document.getElementById("customerNameWorker").value = selectedOption.dataset.name || "";
      document.getElementById("customerPhoneWorker").value = selectedOption.dataset.phone || "";
      
      // Auto-fill service package and pricing details
      if (selectedOption.dataset.package) {
        const packageValue = selectedOption.dataset.package;
        const packageDisplay = getPackageDisplayName(packageValue);
        
        document.getElementById("pricingServiceUpdateDisplay").value = packageDisplay;
        document.getElementById("pricingServiceUpdate").value = packageValue;
        
        showPricingFieldsUpdate();
        
        // Show/hide membership usage section based on package type
        if (packageValue === "membership") {
          document.getElementById("membershipUsageSection").style.display = "block";
          document.getElementById("pricingDetailsUpdate").style.display = "none"; // Hide pricing for membership
          // Load membership balance
          loadMembershipBalance(selectedOption.dataset.phone);
        } else {
          document.getElementById("membershipUsageSection").style.display = "none";
          document.getElementById("pricingDetailsUpdate").style.display = "block"; // Show pricing for non-membership
        }
        
        // Auto-fill plan details based on package type
        if (packageValue === "membership" && selectedOption.dataset.plan) {
          document.getElementById("membershipPlanUpdate").value = selectedOption.dataset.plan;
        } else if (packageValue === "jimat" && selectedOption.dataset.plan) {
          document.getElementById("jimatPlanUpdate").value = selectedOption.dataset.plan;
        } else if (packageValue === "wash" && selectedOption.dataset.quantity) {
          document.getElementById("washKgUpdate").value = selectedOption.dataset.quantity;
        } else if (packageValue === "folding" && selectedOption.dataset.quantity) {
          document.getElementById("foldKgUpdate").value = selectedOption.dataset.quantity;
        } else if (packageValue === "ironing" && selectedOption.dataset.quantity) {
          document.getElementById("ironPcsUpdate").value = selectedOption.dataset.quantity;
        }
        
        // Calculate price after auto-filling (for non-membership packages)
        if (packageValue !== "membership") {
          calcPriceUpdate();
        }
      } else {
        // If no package data, clear the fields
        document.getElementById("pricingServiceUpdateDisplay").value = "";
        document.getElementById("pricingServiceUpdate").value = "";
        document.getElementById("membershipUsageSection").style.display = "none";
        document.getElementById("pricingDetailsUpdate").style.display = "none";
        hideAllPricingUpdate();
      }
    });

  } catch (err) {
    console.error("Error loading customers:", err);
  }
}

// Function to load membership balance from Google Apps Script
async function loadMembershipBalance(phoneNumber) {
  try {
    // This URL would need to be replaced with your actual Google Apps Script URL for membership data
    const response = await fetch(`https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec?phone=${encodeURIComponent(phoneNumber)}`);
    const membershipData = await response.json();
    
    if (membershipData && membershipData.balance) {
      document.getElementById("tripsBalance").textContent = `Trips: ${membershipData.balance.trips || 0}`;
      document.getElementById("weightBalance").textContent = `Weight: ${membershipData.balance.weight || 0} kg`;
    } else {
      document.getElementById("tripsBalance").textContent = "Trips: --";
      document.getElementById("weightBalance").textContent = "Weight: -- kg";
    }
  } catch (err) {
    console.error("Error loading membership balance:", err);
    document.getElementById("tripsBalance").textContent = "Trips: Error loading";
    document.getElementById("weightBalance").textContent = "Weight: Error loading";
  }
}

// Helper function to get display name for package
function getPackageDisplayName(value) {
  const packages = {
    "membership": "Membership",
    "jimat": "Jimat Cuci Bersama",
    "wash": "Wash, Dry & Fold",
    "folding": "Folding",
    "ironing": "Ironing"
  };
  return packages[value] || value;
}

window.addEventListener("DOMContentLoaded", loadCustomers);

// Function to get Brunei formatted date/time
function getBruneiFormattedDateTime(inputId) {
  const dt = document.getElementById(inputId).valueAsDate || new Date();
  return dt.toLocaleString("en-US", {
    timeZone: "Asia/Brunei",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  });
}

// Function to check if selected time is within business hours
function isWithinBusinessHours(dateTime, isPickup = true) {
  const date = new Date(dateTime);
  const day = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  const hours = date.getHours();
  const minutes = date.getMinutes();
  
  // Sunday is closed
  if (day === 0) return false;
  
  // Monday to Friday
  if (day >= 1 && day <= 5) {
    const timeInMinutes = hours * 60 + minutes;
    const startTime = 8 * 60 + 30; // 8:30 AM
    const endTime = 16 * 60 + 30;  // 4:30 PM
    
    return timeInMinutes >= startTime && timeInMinutes <= endTime;
  }
  
  // Saturday
  if (day === 6) {
    const timeInMinutes = hours * 60 + minutes;
    const startTime = 8 * 60 + 30; // 8:30 AM
    const endTime = 11 * 60 + 30;  // 11:30 AM
    
    return timeInMinutes >= startTime && timeInMinutes <= endTime;
  }
  
  return false;
}

// Add event listeners to datetime inputs to check business hours
function addBusinessHoursValidation() {
  const datetimeInputs = [
    document.getElementById('singleDateTime'),
    document.getElementById('pickupDate'),
    document.getElementById('deliveryDate')
  ];
  
  datetimeInputs.forEach(input => {
    if (input) {
      input.addEventListener('change', function() {
        if (this.value) {
          const isPickup = this.id !== 'deliveryDate';
          if (!isWithinBusinessHours(this.value, isPickup)) {
            alert('Warning: The selected time is outside of business hours. Please select a time during our operating hours.');
          }
        }
      });
    }
  });
}

// === Pricing logic for Customer Form ===
const pricingService = document.getElementById('pricingService');
const membershipFields = document.getElementById('membershipFields');
const jimatFields = document.getElementById('jimatFields');

// Hide all pricing fields initially
function hideAllPricingCustomer() {
  [membershipFields, jimatFields].forEach(div => div.style.display = 'none');
}

// Show only membership and jimat fields for customer form
pricingService.addEventListener('change', () => {
  hideAllPricingCustomer();
  if(pricingService.value==='membership') membershipFields.style.display='block';
  if(pricingService.value==='jimat') jimatFields.style.display='block';
});

// === Pricing logic for Update Form ===
const totalPriceUpdateEl = document.getElementById('totalPriceUpdate');
const membershipFieldsUpdate = document.getElementById('membershipFieldsUpdate');
const jimatFieldsUpdate = document.getElementById('jimatFieldsUpdate');
const washFieldsUpdate = document.getElementById('washFieldsUpdate');
const foldingFieldsUpdate = document.getElementById('foldingFieldsUpdate');
const ironingFieldsUpdate = document.getElementById('ironingFieldsUpdate');
const membershipPlanUpdate = document.getElementById('membershipPlanUpdate');
const jimatPlanUpdate = document.getElementById('jimatPlanUpdate');
const washKgUpdate = document.getElementById('washKgUpdate');
const foldKgUpdate = document.getElementById('foldKgUpdate');
const ironPcsUpdate = document.getElementById('ironPcsUpdate');

function hideAllPricingUpdate() {
  [membershipFieldsUpdate, jimatFieldsUpdate, washFieldsUpdate, foldingFieldsUpdate, ironingFieldsUpdate]
    .forEach(div => div.style.display = 'none');
  totalPriceUpdateEl.textContent = '--';
  document.getElementById('priceBreakdownUpdate').textContent = '--';
}

function showPricingFieldsUpdate() {
  hideAllPricingUpdate();
  const packageValue = document.getElementById("pricingServiceUpdate").value;
  
  if(packageValue==='membership') {
    membershipFieldsUpdate.style.display='block';
  } else if(packageValue==='jimat') {
    jimatFieldsUpdate.style.display='block';
  } else if(packageValue==='wash') {
    washFieldsUpdate.style.display='block';
  } else if(packageValue==='folding') {
    foldingFieldsUpdate.style.display='block';
  } else if(packageValue==='ironing') {
    ironingFieldsUpdate.style.display='block';
  }
}

function calcPriceUpdate() {
  let price = 0;
  let breakdown = '';
  const packageValue = document.getElementById("pricingServiceUpdate").value;
  
  // Skip calculation for membership
  if (packageValue === "membership") {
    totalPriceUpdateEl.textContent = "--";
    document.getElementById('priceBreakdownUpdate').textContent = "--";
    return;
  }
  
  switch(packageValue) {
    case 'jimat':
      if(jimatPlanUpdate.value){
        price = parseFloat(jimatPlanUpdate.value);
        breakdown = `$${price.toFixed(2)} (${jimatPlanUpdate.options[jimatPlanUpdate.selectedIndex].text})`;
      }
      break;
    case 'wash':
      const kg = parseInt(washKgUpdate.value) || 0;
      if(kg>0){
        if(kg<=5) price=10;
        else if(kg<=8) price=12;
        else if(kg<=13) price=16;
        else price=16+(kg-13)*1.2;
        breakdown = kg>13 ? `Base 13kg = $16 + ${kg-13}kg×$1.20 = $${price.toFixed(2)}` : `$${price.toFixed(2)} for ${kg}kg`;
      }
      break;
    case 'folding':
      const fkg = parseInt(foldKgUpdate.value) || 0;
      if(fkg>0){
        if(fkg<=7) price=2;
        else price=2+Math.floor((fkg-7)/2)*1;
        breakdown = `$${price.toFixed(2)} for ${fkg}kg`;
      }
      break;
    case 'ironing':
      const pcs = parseInt(ironPcsUpdate.value) || 0;
      if(pcs>0){
        price=pcs*1;
        breakdown = `$${price.toFixed(2)} for ${pcs} pieces`;
      }
      break;
  }
  totalPriceUpdateEl.textContent = price>0 ? "$"+price.toFixed(2) : "--";
  document.getElementById('priceBreakdownUpdate').textContent = breakdown || '--';
}

// Add event listeners for price calculation (excluding membership)
[jimatPlanUpdate, washKgUpdate, foldKgUpdate, ironPcsUpdate].forEach(el=>{
  el.addEventListener('input', calcPriceUpdate);
  el.addEventListener('change', calcPriceUpdate);
});

// Submit handler
document.getElementById('appointmentForm').addEventListener('submit', async function(e){
  e.preventDefault();

  // Check if datetime is within business hours
  const singleDateTime = document.getElementById('singleDateTime');
  const pickupDate = document.getElementById('pickupDate');
  const deliveryDate = document.getElementById('deliveryDate');
  
  if (singleDateTime && singleDateTime.value && !isWithinBusinessHours(singleDateTime.value, serviceSelect.value === 'Pick Up Only')) {
    if (!confirm('The selected time is outside of business hours. Are you sure you want to proceed?')) {
      return;
    }
  }
  
  if (pickupDate && pickupDate.value && !isWithinBusinessHours(pickupDate.value, true)) {
    if (!confirm('The selected pickup time is outside of business hours. Are you sure you want to proceed?')) {
      return;
    }
  }
  
  if (deliveryDate && deliveryDate.value && !isWithinBusinessHours(deliveryDate.value, false)) {
    if (!confirm('The selected delivery time is outside of business hours. Are you sure you want to proceed?')) {
      return;
    }
  }

  // Fill hidden formatted fields for customer form
  if(formMode.value === 'customer') {
    document.getElementById('singleDateFormatted').value = getBruneiFormattedDateTime('singleDateTime');
    document.getElementById('pickupDateFormatted').value = getBruneiFormattedDateTime('pickupDate');
    document.getElementById('deliveryDateFormatted').value = getBruneiFormattedDateTime('deliveryDate');
  }

  const formData = new FormData(this);

  try {
    const response = await fetch(this.action, { method: this.method, body: formData });
    if(response.ok){
      document.getElementById('thankYouPopup').style.display = 'flex';
      this.reset();
      serviceFields.style.display = 'none';
      singleAddressSection.style.display = 'none';
      pickUpDeliverySection.style.display = 'none';
      document.getElementById('deliveryDateSection').style.display = 'none';
      hideAllPricingCustomer();
      hideAllPricingUpdate();
      document.getElementById("membershipUsageSection").style.display = "none";
      document.getElementById("pricingDetailsUpdate").style.display = "none";

      if(formMode.value === 'update'){
        const customerSelect = document.getElementById('customerRef');
        const selectedIndex = customerSelect.selectedIndex;
        if(selectedIndex > 0){ customerSelect.remove(selectedIndex); }
        customerSelect.selectedIndex = 0;
        document.getElementById('mapLinkWorker').value = ""; 
        document.getElementById('serviceWorker').value = "";
        document.getElementById('pricingServiceUpdateDisplay').value = "";
        document.getElementById('pricingServiceUpdate').value = "";
      }

    } else { 
      alert('Error submitting the form. Please try again.'); 
    }
  } catch(err){
    alert('Error submitting the form. Check your internet connection.');
    console.error(err);
  }
});

// Initialize business hours validation
addBusinessHoursValidation();
</script>
</body>
</html>
