<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultra Wash Customer Form</title>
<style>
:root {
  --font-family: 'Open Sans', sans-serif;
  --font-size-label: 14px;
  --font-size-input: 14px;
  --font-size-header: 22px;
  --color-background: #f6f7fa;
  --color-card-bg: #ffffff;
  --color-card-border: #dbdfe7;
  --color-card-shadow: rgba(99, 77, 255, 0.06);
  --color-header: #333;
  --color-label: #555;
  --color-input-border: #ccc;
  --color-input-text: #333;
  --color-focus-border: #5a4cc2;
  --color-btn-bg: #ff6d5a;
  --color-btn-text: #fff;
  --radius: 6px;
  --container-width: 440px;
  --color-valid: #4caf50;
}
body {
  font-family: var(--font-family);
  background-color: var(--color-background);
  display: flex;
  justify-content: center;
  padding: 32px;
}
form {
  background: var(--color-card-bg);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px var(--color-card-shadow);
  padding: 24px;
  width: var(--container-width);
}
h1 {
  text-align: center;
  font-size: var(--font-size-header);
  color: var(--color-header);
  margin-bottom: 24px;
}
label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: var(--font-size-label);
}
input[type="text"],
input[type="tel"],
input[type="datetime-local"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 10px;
  font-size: var(--font-size-input);
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 16px;
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
  font-family: var(--font-family); /* Ensure consistent font */
}
input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--color-focus-border);
  box-shadow: 0 0 4px var(--color-focus-border);
}
/* Green border for filled fields */
input:not(:placeholder-shown):valid,
textarea:not(:placeholder-shown):valid,
select:valid {
  border-color: var(--color-valid);
}
/* NEW: Consistent placeholder styling */
::placeholder {
  color: #999;
  font-family: var(--font-family);
  font-size: var(--font-size-input);
}
textarea { 
  resize: vertical; 
  font-family: var(--font-family); /* Ensure consistent font */
}
button[type="submit"] {
  background-color: var(--color-btn-bg);
  color: var(--color-btn-text);
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: var(--font-size-input);
  cursor: pointer;
  margin-bottom: 16px;
}
button[type="submit"]:hover { background-color: #e05343; }
.note { font-size: 13px; color: #555; margin: 4px 0 16px 0; line-height: 1.4; }
.small-checkbox-label { font-size: 13px; margin-left: 4px; }
#thankYouPopup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#thankYouPopup .popup-content {
  background: white;
  border-radius: 12px;
  padding: 24px 16px;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
#thankYouPopup .checkmark { font-size: 48px; color: #4CAF50; margin-bottom: 16px; }
#thankYouPopup h1 { font-size: 20px; margin-bottom: 12px; color: #222; }
#thankYouPopup p { font-size: 15px; color: #555; line-height: 1.6; margin: 0; }
#thankYouPopup button {
  margin-top: 20px;
  background-color: #ff6d5a;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}
#sameAsPickupWrapper { margin-bottom: 8px; }
.same-as-active { margin-bottom: 40px; }
.pricing-details {
  background-color: #f9f9f9;
  border-left: 4px solid #5a4cc2;
  padding: 10px;
  margin-bottom: 16px;
  border-radius: 4px;
}
.auto-filled {
  background-color: #f0f7ff;
  border-left: 4px solid #4a90e2;
}
.membership-usage {
  background-color: #f8f9fa;
  border-left: 4px solid #4a90e2;
  padding: 15px;
  margin-bottom: 16px;
  border-radius: 4px;
}
.membership-usage h3 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #2c3e50;
  font-size: 16px;
}

/* NEW: Custom dropdown styles */
.custom-dropdown {
  position: relative;
  margin-bottom: 16px;
}

.dropdown-select {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  cursor: pointer;
  background-color: white;
  font-size: var(--font-size-input); /* Ensure same font size */
}

.dropdown-select:after {
  content: "▼";
  font-size: 12px;
  transition: transform 0.2s;
}

.dropdown-select.open:after {
  transform: rotate(180deg);
}

.dropdown-search {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  box-sizing: border-box;
  display: none;
  font-size: var(--font-size-input); /* Ensure same font size */
}

.dropdown-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  background: white;
  z-index: 100;
  display: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.dropdown-options.open {
  display: block;
}

.dropdown-option {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  font-size: var(--font-size-input); /* Ensure same font size */
}

.dropdown-option:last-child {
  border-bottom: none;
}

.dropdown-option:hover {
  background-color: #f6f7fa;
}

.dropdown-option.selected {
  background-color: #e6f7ff;
  font-weight: 600;
}

/* Scrollable select styling */
.scrollable-select {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 16px;
}
.scrollable-select select {
  border: none;
  margin-bottom: 0;
}
.scrollable-select select:focus {
  outline: none;
  box-shadow: none;
}

/* Hidden backend address styling */
.backend-address {
  display: none !important;
}

/* NEW: Hidden address field for update form */
.hidden-address-field {
  display: none !important;
}
</style>
</head>
<body>

<!-- Remove the action attribute and let JavaScript handle submission -->
<form id="appointmentForm" novalidate>
  <h1>Ultra Wash Appointment</h1>

  <!-- Form Type Selection -->
  <label for="formMode">Form Type</label>
  <select id="formMode" name="formMode" required>
    <option value="" disabled selected>Select Form Type</option>
    <option value="customer">Customer Form</option>
    <option value="update">Update Form</option>
  </select>

  <!-- Customer Form -->
  <div id="customerForm" style="display:none;">
    <label for="name">Full Name</label>
    <input id="name" name="name" type="text" placeholder="First Name, Last Name" required />

    <label for="phone">Phone Number</label>
    <input id="phone" name="phone" type="tel" placeholder="+673 8221133 / 8221133" required />

    <!-- Service Package Field -->
    <label for="pricingService">Service Package</label>
    <select id="pricingService" name="pricingService" required>
      <option value="" disabled selected>-- Select Package --</option>
      <option value="membership">Membership</option>
      <option value="jimat">Jimat Cuci Bersama</option>
      <option value="wash">Wash, Dry & Fold</option>
      <option value="folding">Folding</option>
      <option value="ironing">Ironing</option>
    </select>

    <!-- Membership options -->
    <div id="membershipFields" style="display:none;">
      <label for="membershipPlan">Membership Plan</label>
      <select id="membershipPlan" name="membershipPlan" required>
        <option value="" disabled selected>-- Select Plan --</option>
        <option value="120-12-60">$120 – 12 trips (60kg)</option>
        <option value="100-2-50">$100 – 2x/week (max 50kg, 1 address)</option>
      </select>
    </div>

    <!-- Jimat options -->
    <div id="jimatFields" style="display:none;">
      <label for="jimatPlan">Jimat Cuci Bersama</label>
      <select id="jimatPlan" name="jimatPlan" required>
        <option value="" disabled selected>-- Select Box --</option>
        <option value="16">$16 / 1 box</option>
        <option value="28">$28 / 2 boxes</option>
        <option value="40">$40 / 4 boxes</option>
      </select>
    </div>

    <!-- Static Price Display (No Live Calculation) -->
    <div class="note"><strong>Price will be calculated after selection</strong></div>

    <label for="service">Service</label>
    <select id="service" name="service" required>
      <option value="" disabled selected>Select service</option>
      <option value="Self Drop-off & Pick Up">Self Drop-off & Pick Up</option>
      <option value="Pick Up Only">Pick Up Only</option>
      <option value="Delivery Only">Delivery Only</option>
      <option value="Pick Up & Delivery">Pick Up & Delivery</option>
    </select>

    <div id="serviceFields" style="display:none;">
      <div id="singleAddressSection" style="display:none;">
        <label id="singleAddressLabel">Address</label>
        <textarea id="singleAddress" name="singleAddress" placeholder="Enter your address" rows="3" required></textarea>
        <label for="singleMapLink">Map Link</label>
        <input id="singleMapLink" name="singleMapLink" type="text" placeholder="Paste Google Maps link or Coordinates" required />
        <label id="singleDateLabel">Date & Time</label>
        <div class="note" id="singleDateNote"></div>
        <input type="datetime-local" id="singleDateTime" name="singleDateTime" required />
        <input type="hidden" id="singleDateFormatted" name="singleDateFormatted">
      </div>

      <div id="pickUpDeliverySection" style="display:none;">
        <label>Pick Up Location</label>
        <textarea id="pickupAddress" name="pickupAddress" placeholder="Enter your address" rows="3" required></textarea>
        <label for="pickupMapLink">Map Link</label>
        <input id="pickupMapLink" name="pickupMapLink" type="text" placeholder="Paste Google Maps link" required />
        <label>Pick Up Date & Time</label>
        <div class="note">⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
        <input type="datetime-local" id="pickupDate" name="pickupDate" required />
        <input type="hidden" id="pickupDateFormatted" name="pickupDateFormatted">

        <label>Delivery Location</label>
        <div id="sameAsPickupWrapper">
          <input type="checkbox" id="sameAsPickup"> 
          <span class="small-checkbox-label">Delivery address same as Pickup</span>
        </div>
        <textarea id="deliveryAddress" name="deliveryAddress" placeholder="Enter your address" rows="3" required></textarea>
        <label for="deliveryMapLink" id="deliveryMapLabel">Map Link</label>
        <input id="deliveryMapLink" name="deliveryMapLink" type="text" placeholder="Paste Google Maps link" required />
        <div id="deliveryDateSection" style="display:none;">
          <label>Delivery Date & Time</label>
          <div class="note">⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
          <input type="datetime-local" id="deliveryDate" name="deliveryDate" required />
          <input type="hidden" id="deliveryDateFormatted" name="deliveryDateFormatted">
        </div>
      </div>
    </div>
  </div>

  <!-- Update Form (Worker Form) -->
  <div id="updateForm" style="display:none;">
    <label for="customerRef">Customer Reference (Phone/ID)</label>
    
    <!-- NEW: Custom dropdown implementation -->
    <div class="custom-dropdown" id="customerRefDropdown">
      <div class="dropdown-select" id="customerRefSelect">
        <span>Select Customer</span>
      </div>
      <input type="text" class="dropdown-search" id="customerRefSearch" placeholder="Search customers...">
      <div class="dropdown-options" id="customerRefOptions"></div>
      <input type="hidden" id="customerRef" name="customerRef" required>
    </div>

    <!-- Hidden Phone Number (for backend only) -->
    <input id="customerPhoneWorker" name="customerPhoneWorker" type="hidden" />

    <!-- Hidden Backend Address (for backend only) -->
    <input id="backendAddress" name="backendAddress" type="hidden" class="backend-address" />
    
    <!-- NEW: Hidden Address Field for Update Form -->
    <input id="addressWorker" name="addressWorker" type="hidden" class="hidden-address-field" />

    <label for="mapLinkWorker">Map Link</label>
    <input id="mapLinkWorker" name="mapLinkWorker" type="text" readonly placeholder="Auto-filled from Customer Data" class="auto-filled" />

    <label for="serviceWorker">Service Type</label>
    <input id="serviceWorker" name="serviceWorker" type="text" readonly placeholder="Auto-filled from Customer Data" class="auto-filled" />

    <!-- Hidden Customer Name -->
    <input id="customerNameWorker" name="customerNameWorker" type="hidden" />

    <!-- Service Package Field for Update Form (Readonly) -->
    <label for="pricingServiceUpdate">Service Package</label>
    <input id="pricingServiceUpdateDisplay" name="pricingServiceUpdateDisplay" type="text" readonly class="auto-filled" />
    <input id="pricingServiceUpdate" name="pricingServiceUpdate" type="hidden" />

    <!-- Update Form Pricing Fields -->
    <div id="membershipFieldsUpdate" style="display:none;">
      <label for="membershipPlanUpdate">Membership Plan</label>
      <select id="membershipPlanUpdate" name="membershipPlanUpdate" disabled>
        <option value="" disabled selected>-- Select Plan --</option>
        <option value="120-12-60">$120 – 12 trips (60kg)</option>
        <option value="100-2-50">$100 – 2x/week (max 50kg, 1 address)</option>
      </select>
    </div>

    <div id="jimatFieldsUpdate" style="display:none;">
      <label for="jimatPlanUpdate">Jimat Cuci Bersama</label>
      <select id="jimatPlanUpdate" name="jimatPlanUpdate" disabled>
        <option value="" disabled selected>-- Select Box --</option>
        <option value="16">$16 / 1 box</option>
        <option value="28">$28 / 2 boxes</option>
        <option value="40">$40 / 4 boxes</option>
      </select>
    </div>

    <div id="washFieldsUpdate" style="display:none;">
      <label for="washKgUpdate">Weight (kg)</label>
      <input type="number" id="washKgUpdate" name="washKgUpdate" min="1" step="1" required />
    </div>

    <div id="foldingFieldsUpdate" style="display:none;">
      <label for="foldKgUpdate">Weight (kg)</label>
      <input type="number" id="foldKgUpdate" name="foldKgUpdate" min="1" step="1" required />
    </div>

    <div id="ironingFieldsUpdate" style="display:none;">
      <label for="ironPcsUpdate">Number of Pieces</label>
      <input type="number" id="ironPcsUpdate" name="ironPcsUpdate" min="1" step="1" required />
    </div>

    <!-- Membership Usage Tracking (Only shown for membership customers) -->
    <div id="membershipUsageSection" class="membership-usage" style="display:none;">
      <h3>Membership Usage</h3>
      <label for="tripsUsed">Trips Used</label>
      <input type="number" id="tripsUsed" name="tripsUsed" min="0" step="1" value="1" required />
      
      <label for="weightUsed">Weight Used (Kg)</label>
      <input type="number" id="weightUsed" name="weightUsed" min="0" step="0.1" required />
      
      <!-- Membership Balance Display -->
      <div id="membershipBalance" style="margin-top: 10px; padding: 10px; background-color: #e8f4fc; border-radius: 4px;">
        <strong>Current Balance:</strong><br>
        <span id="tripsBalance">Trips Remaining: --</span><br>
        <span id="weightBalance">Weight Remaining: -- kg</span>
      </div>
    </div>

    <!-- Live Calculation for Update Form (Hidden for membership) -->
    <div id="pricingDetailsUpdate" class="pricing-details" style="display:none;">
      <strong>Total Price: <span id="totalPriceUpdate">--</span></strong><br>
      <strong>Price Breakdown: <span id="priceBreakdownUpdate">--</span></strong>
    </div>

    <label for="totalItems">Total Items</label>
    <input id="totalItems" name="totalItems" type="number" min="1" placeholder="Enter total items" required />
  </div>

  <button type="submit">Submit</button>
</form>

<div id="thankYouPopup">
  <div class="popup-content">
    <div class="checkmark">✅</div>
    <h1>Thank you!</h1>
    <p>Form has been successfully submitted.<br>Please update accordingly.</p>
    <button onclick="closePopup()">Close</button>
  </div>
</div>

<script>
// Global variables to store membership balance and customers
let currentTripsBalance = 0;
let currentWeightBalance = 0;
let allCustomers = [];

const formMode = document.getElementById('formMode');
const customerForm = document.getElementById('customerForm');
const updateForm = document.getElementById('updateForm');
const serviceSelect = document.getElementById('service');
const serviceFields = document.getElementById('serviceFields');
const singleAddressSection = document.getElementById('singleAddressSection');
const pickUpDeliverySection = document.getElementById('pickUpDeliverySection');
const sameAsPickup = document.getElementById('sameAsPickup');
const sameAsPickupWrapper = document.getElementById('sameAsPickupWrapper');
const deliveryAddress = document.getElementById('deliveryAddress');
const deliveryMapLink = document.getElementById('deliveryMapLink');
const deliveryMapLabel = document.getElementById('deliveryMapLabel');

// NEW: Custom dropdown elements
const customerRefDropdown = document.getElementById('customerRefDropdown');
const customerRefSelect = document.getElementById('customerRefSelect');
const customerRefSearch = document.getElementById('customerRefSearch');
const customerRefOptions = document.getElementById('customerRefOptions');
const customerRefHidden = document.getElementById('customerRef');

// NEW: Hidden address field for update form
const addressWorker = document.getElementById('addressWorker');

// Switch form modes
formMode.addEventListener('change', () => {
  if(formMode.value === 'customer'){
    customerForm.style.display = 'block';
    updateForm.style.display = 'none';
    serviceFields.style.display = 'none';
  } else if(formMode.value === 'update'){
    customerForm.style.display = 'none';
    updateForm.style.display = 'block';
  }
});

// Service selection
serviceSelect.addEventListener('change', () => {
  serviceFields.style.display = 'block';
  if(serviceSelect.value === 'Self Drop-off & Pick Up'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'none';
  } else if(serviceSelect.value === 'Pick Up Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Pick Up Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Delivery Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Delivery Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Pick Up & Delivery'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'block';
    sameAsPickup.checked = false;
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Delivery same as pickup toggle
sameAsPickup.addEventListener('change', () => {
  if(sameAsPickup.checked){
    deliveryAddress.style.display = 'none';
    deliveryMapLink.style.display = 'none';
    deliveryMapLabel.style.display = 'none';
    document.getElementById('deliveryDateSection').style.display = 'none';
    sameAsPickupWrapper.classList.add('same-as-active');
  } else {
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Close popup
function closePopup(){ 
  document.getElementById('thankYouPopup').style.display='none'; 
  // Optionally reset the form after successful submission
  document.getElementById('appointmentForm').reset();
  // Reset form visibility
  customerForm.style.display = 'none';
  updateForm.style.display = 'none';
  serviceFields.style.display = 'none';
  singleAddressSection.style.display = 'none';
  pickUpDeliverySection.style.display = 'none';
  formMode.selectedIndex = 0;
}

// Function to update membership balance in real-time
function updateMembershipBalance() {
  const tripsUsed = parseInt(document.getElementById("tripsUsed").value) || 0;
  const weightUsed = parseFloat(document.getElementById("weightUsed").value) || 0;
  
  // Calculate remaining values using the stored balance values
  const tripsRemaining = currentTripsBalance - tripsUsed;
  const weightRemaining = currentWeightBalance - weightUsed;
  
  // Update the display with remaining values
  document.getElementById("tripsBalance").textContent = `Trips Remaining: ${tripsRemaining >= 0 ? tripsRemaining : 0}`;
  document.getElementById("weightBalance").textContent = `Weight Remaining: ${weightRemaining >= 0 ? weightRemaining.toFixed(1) : 0} kg`;
}

// Function to load membership balance from Google Apps Script
async function loadMembershipBalance(phoneNumber) {
  try {
    const response = await fetch(`https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec?type=membership&phone=${encodeURIComponent(phoneNumber)}`);
    const membershipData = await response.json();
    
    // Check if there's an error in the response
    if (membershipData.error) {
      console.error("Error from server:", membershipData.error);
      document.getElementById("tripsBalance").textContent = "Error loading balance";
      document.getElementById("weightBalance").textContent = "Error loading balance";
      return;
    }
    
    if (membershipData && membershipData.balance) {
      // Store the actual balance values in variables
      currentTripsBalance = parseInt(membershipData.balance.trips) || 0;
      currentWeightBalance = parseFloat(membershipData.balance.weight) || 0;
      
      // Display the initial balance
      document.getElementById("tripsBalance").textContent = `Trips Remaining: ${currentTripsBalance}`;
      document.getElementById("weightBalance").textContent = `Weight Remaining: ${currentWeightBalance} kg`;
      
      // Add event listeners to update balance when values change
      document.getElementById("tripsUsed").addEventListener("input", updateMembershipBalance);
      document.getElementById("weightUsed").addEventListener("input", updateMembershipBalance);
      
      // Set initial values for trips and weight used
      document.getElementById("tripsUsed").value = "1";
      document.getElementById("weightUsed").value = "";
    } else {
      document.getElementById("tripsBalance").textContent = "Trips Remaining: --";
      document.getElementById("weightBalance").textContent = "Weight Remaining: -- kg";
    }
  } catch (err) {
    console.error("Error loading membership balance:", err);
    document.getElementById("tripsBalance").textContent = "Trips Remaining: Error loading";
    document.getElementById("weightBalance").textContent = "Weight Remaining: Error loading";
  }
}

// NEW: Custom dropdown functionality
function setupCustomDropdown() {
  // Toggle dropdown visibility
  customerRefSelect.addEventListener('click', function(e) {
    e.stopPropagation();
    customerRefDropdown.classList.toggle('open');
    customerRefSearch.style.display = customerRefDropdown.classList.contains('open') ? 'block' : 'none';
    customerRefOptions.classList.toggle('open');
    
    if (customerRefDropdown.classList.contains('open')) {
      customerRefSearch.focus();
    }
  });
  
  // Filter options when typing in search
  customerRefSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const options = customerRefOptions.querySelectorAll('.dropdown-option');
    
    options.forEach(option => {
      const text = option.textContent.toLowerCase();
      option.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!customerRefDropdown.contains(e.target)) {
      customerRefDropdown.classList.remove('open');
      customerRefSearch.style.display = 'none';
      customerRefOptions.classList.remove('open');
    }
  });
  
  // Prevent closing when clicking inside dropdown
  customerRefDropdown.addEventListener('click', function(e) {
    e.stopPropagation();
  });
}

// NEW: Populate custom dropdown with customers
function populateCustomDropdown(customers) {
  customerRefOptions.innerHTML = '';
  
  customers.forEach(cust => {
    const option = document.createElement('div');
    option.className = 'dropdown-option';
    option.textContent = `${cust["Name"]} (${cust["Customer ID"]})`;
    option.dataset.value = cust["Customer ID"] || cust["Phone"];
    option.dataset.maplink = cust["Map Link / Coordinates"];
    option.dataset.address = cust["Location Address"];
    option.dataset.service = cust["Service Type"] || "";
    option.dataset.name = cust["Name"];
    option.dataset.phone = cust["Phone"];
    option.dataset.package = cust["Service Package"] || "";
    option.dataset.plan = cust["Plan Details"] || "";
    option.dataset.quantity = cust["Quantity"] || "";
    
    option.addEventListener('click', function() {
      // Update selected value
      customerRefHidden.value = this.dataset.value;
      customerRefSelect.querySelector('span').textContent = this.textContent;
      
      // Close dropdown
      customerRefDropdown.classList.remove('open');
      customerRefSearch.style.display = 'none';
      customerRefOptions.classList.remove('open');
      
      // Remove previous selections
      customerRefOptions.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Highlight selected option
      this.classList.add('selected');
      
      // Auto-fill other fields
      document.getElementById("mapLinkWorker").value = this.dataset.maplink || "";
      document.getElementById("serviceWorker").value = this.dataset.service || "";
      document.getElementById("customerNameWorker").value = this.dataset.name || "";
      document.getElementById("customerPhoneWorker").value = this.dataset.phone || "";
      document.getElementById("backendAddress").value = this.dataset.address || ""; // Set hidden backend address
      addressWorker.value = this.dataset.address || ""; // Set hidden address field
      
      // Auto-fill service package and pricing details
      if (this.dataset.package) {
        const packageValue = this.dataset.package;
        const packageDisplay = getPackageDisplayName(packageValue);
        
        document.getElementById("pricingServiceUpdateDisplay").value = packageDisplay;
        document.getElementById("pricingServiceUpdate").value = packageValue;
        
        showPricingFieldsUpdate();
        
        // Show/hide membership usage section based on package type
        if (packageValue === "membership") {
          document.getElementById("membershipUsageSection").style.display = "block";
          document.getElementById("pricingDetailsUpdate").style.display = "none"; // Hide pricing for membership
          
          // Load membership balance
          loadMembershipBalance(this.dataset.phone);
        } else {
          document.getElementById("membershipUsageSection").style.display = "none";
          document.getElementById("pricingDetailsUpdate").style.display = "block"; // Show pricing for non-membership
          
          // Remove event listeners if they exist
          document.getElementById("tripsUsed").removeEventListener("input", updateMembershipBalance);
          document.getElementById("weightUsed").removeEventListener("input", updateMembershipBalance);
        }
        
        // Auto-fill plan details based on package type
        if (packageValue === "membership" && this.dataset.plan) {
          document.getElementById("membershipPlanUpdate").value = this.dataset.plan;
        } else if (packageValue === "jimat" && this.dataset.plan) {
          document.getElementById("jimatPlanUpdate").value = this.dataset.plan;
        } else if (packageValue === "wash" && this.dataset.quantity) {
          document.getElementById("washKgUpdate").value = this.dataset.quantity;
        } else if (packageValue === "folding" && this.dataset.quantity) {
          document.getElementById("foldKgUpdate").value = this.dataset.quantity;
        } else if (packageValue === "ironing" && this.dataset.quantity) {
          document.getElementById("ironPcsUpdate").value = this.dataset.quantity;
        }
        
        // Calculate price after auto-filling (for non-membership packages)
        if (packageValue !== "membership") {
          calcPriceUpdate();
        }
      } else {
        // If no package data, clear the fields
        document.getElementById("pricingServiceUpdateDisplay").value = "";
        document.getElementById("pricingServiceUpdate").value = "";
        document.getElementById("membershipUsageSection").style.display = "none";
        document.getElementById("pricingDetailsUpdate").style.display = "none";
        hideAllPricingUpdate();
      }
    });
    
    customerRefOptions.appendChild(option);
  });
}

// Load customer list from Google Apps Script
async function loadCustomers() {
  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec");
    allCustomers = await response.json();
    
    // Set up custom dropdown
    setupCustomDropdown();
    populateCustomDropdown(allCustomers);

  } catch (err) {
    console.error("Error loading customers:", err);
  }
}

// Helper function to get display name for package
function getPackageDisplayName(value) {
  const packages = {
    "membership": "Membership",
    "jimat": "Jimat Cuci Bersama",
    "wash": "Wash, Dry & Fold",
    "folding": "Folding",
    "ironing": "Ironing"
  };
  return packages[value] || value;
}

window.addEventListener("DOMContentLoaded", loadCustomers);

// Function to get Brunei formatted date/time
function getBruneiFormattedDateTime(inputId) {
  const dt = document.getElementById(inputId).valueAsDate || new Date();
  return dt.toLocaleString("en-US", {
    timeZone: "Asia/Brunei",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  });
}

// Function to check if selected time is within business hours
function isWithinBusinessHours(dateTimeInputId, serviceType) {
  const dateTime = document.getElementById(dateTimeInputId).valueAsDate;
  if (!dateTime) return true; // Skip validation if no date selected
  
  const day = dateTime.getDay(); // 0 = Sunday, 1 = Monday, etc.
  const hours = dateTime.getHours();
  const minutes = dateTime.getMinutes();
  
  // Business hours
  const weekdaysOpen = 8.5; // 8:30 AM
  const weekdaysClose = 16.5; // 4:30 PM
  const saturdayOpen = 8.5; // 8:30 AM
  const saturdayClose = 11.5; // 11:30 AM
  
  // Check if it's a valid business day/time
  if (day === 0) { // Sunday
    return false;
  } else if (day === 6) { // Saturday
    return hours >= saturdayOpen && (hours < saturdayClose || (hours === saturdayClose && minutes === 0));
  } else { // Weekdays
    return hours >= weekdaysOpen && (hours < weekdaysClose || (hours === weekdaysClose && minutes === 0));
  }
}

// Function to show appropriate pricing fields in update form
function showPricingFieldsUpdate() {
  const packageType = document.getElementById("pricingServiceUpdate").value;
  
  // Hide all fields first
  hideAllPricingUpdate();
  
  // Show relevant fields based on package type
  if (packageType === "membership") {
    document.getElementById("membershipFieldsUpdate").style.display = "block";
  } else if (packageType === "jimat") {
    document.getElementById("jimatFieldsUpdate").style.display = "block";
  } else if (packageType === "wash") {
    document.getElementById("washFieldsUpdate").style.display = "block";
  } else if (packageType === "folding") {
    document.getElementById("foldingFieldsUpdate").style.display = "block";
  } else if (packageType === "ironing") {
    document.getElementById("ironingFieldsUpdate").style.display = "block";
  }
}

// Function to hide all pricing fields in update form
function hideAllPricingUpdate() {
  document.getElementById("membershipFieldsUpdate").style.display = "none";
  document.getElementById("jimatFieldsUpdate").style.display = "none";
  document.getElementById("washFieldsUpdate").style.display = "none";
  document.getElementById("foldingFieldsUpdate").style.display = "none";
  document.getElementById("ironingFieldsUpdate").style.display = "none";
}

// Function to calculate price for update form
function calcPriceUpdate() {
  const packageType = document.getElementById("pricingServiceUpdate").value;
  let price = 0;
  let breakdown = "";
  
  if (packageType === "jimat") {
    const plan = document.getElementById("jimatPlanUpdate").value;
    price = parseFloat(plan) || 0;
    breakdown = `Jimat Plan: $${price}`;
  } else if (packageType === "wash") {
    const kg = parseFloat(document.getElementById("washKgUpdate").value) || 0;
    price = kg * 1.5; // $1.50 per kg
    breakdown = `Wash: ${kg}kg × $1.50 = $${price.toFixed(2)}`;
  } else if (packageType === "folding") {
    const kg = parseFloat(document.getElementById("foldKgUpdate").value) || 0;
    price = kg * 1.0; // $1.00 per kg
    breakdown = `Folding: ${kg}kg × $1.00 = $${price.toFixed(2)}`;
  } else if (packageType === "ironing") {
    const pcs = parseFloat(document.getElementById("ironPcsUpdate").value) || 0;
    price = pcs * 1.0; // $1.00 per piece
    breakdown = `Ironing: ${pcs}pcs × $1.00 = $${price.toFixed(2)}`;
  }
  
  // Update the price display
  document.getElementById("totalPriceUpdate").textContent = `$${price.toFixed(2)}`;
  document.getElementById("priceBreakdownUpdate").textContent = breakdown;
}

// Add event listeners for price calculation in update form
document.getElementById("jimatPlanUpdate").addEventListener("change", calcPriceUpdate);
document.getElementById("washKgUpdate").addEventListener("input", calcPriceUpdate);
document.getElementById("foldKgUpdate").addEventListener("input", calcPriceUpdate);
document.getElementById("ironPcsUpdate").addEventListener("input", calcPriceUpdate);

// Form submission
document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Validate form based on type
  const isCustomerForm = formMode.value === 'customer';
  const isUpdateForm = formMode.value === 'update';
  
  // Validate business hours for customer form
  if (isCustomerForm) {
    let dateTimeValid = true;
    let errorMessage = "";
    
    if (serviceSelect.value === 'Pick Up Only') {
      if (!isWithinBusinessHours('singleDateTime', 'pickup')) {
        dateTimeValid = false;
        errorMessage = "Pick Up time must be within business hours:\nMon-Fri: 8:30 AM - 4:30 PM\nSat: 8:30 AM - 11:30 AM";
      }
    } else if (serviceSelect.value === 'Delivery Only') {
      if (!isWithinBusinessHours('singleDateTime', 'delivery')) {
        dateTimeValid = false;
        errorMessage = "Delivery time must be within business hours:\nMon-Fri: 8:30 AM - 4:30 PM\nSat: 8:30 AM - 11:30 AM";
      }
    } else if (serviceSelect.value === 'Pick Up & Delivery') {
      if (!isWithinBusinessHours('pickupDate', 'pickup')) {
        dateTimeValid = false;
        errorMessage = "Pick Up time must be within business hours:\nMon-Fri: 8:30 AM - 4:30 PM\nSat: 8:30 AM - 11:30 AM";
      } else if (!sameAsPickup.checked && !isWithinBusinessHours('deliveryDate', 'delivery')) {
        dateTimeValid = false;
        errorMessage = "Delivery time must be within business hours:\nMon-Fri: 8:30 AM - 4:30 PM\nSat: 8:30 AM - 11:30 AM";
      }
    }
    
    if (!dateTimeValid) {
      alert(errorMessage);
      return false;
    }
  }
  
  // Format dates for submission
  if (isCustomerForm) {
    if (serviceSelect.value === 'Pick Up Only' || serviceSelect.value === 'Delivery Only') {
      document.getElementById('singleDateFormatted').value = getBruneiFormattedDateTime('singleDateTime');
    } else if (serviceSelect.value === 'Pick Up & Delivery') {
      document.getElementById('pickupDateFormatted').value = getBruneiFormattedDateTime('pickupDate');
      if (!sameAsPickup.checked) {
        document.getElementById('deliveryDateFormatted').value = getBruneiFormattedDateTime('deliveryDate');
      }
    }
  }
  
  // Prepare form data
  const formData = new FormData(this);
  
  // Add form type to data
  formData.append('formType', formMode.value);
  
  // Add hidden address field value to form data in update form
  if (isUpdateForm) {
    formData.append('addressWorker', addressWorker.value);
  }
  
  try {
    // Send data to Google Apps Script
    const response = await fetch('https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      // Show success popup
      document.getElementById('thankYouPopup').style.display = 'flex';
    } else {
      alert('Error submitting form: ' + result.message);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error submitting form. Please try again.');
  }
});
</script>
</body>
</html>
