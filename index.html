<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultra Wash Appointment Form</title>
<style>
:root {
  --font-family: 'Open Sans', sans-serif;
  --font-size-label: 14px;
  --font-size-input: 14px;
  --font-size-header: 22px;
  --color-background: #f6f7fa;
  --color-card-bg: #ffffff;
  --color-card-border: #dbdfe7;
  --color-card-shadow: rgba(99, 77, 255, 0.06);
  --color-header: #333;
  --color-label: #555;
  --color-input-border: #ccc;
  --color-input-text: #333;
  --color-focus-border: #5a4cc2;
  --color-btn-bg: #ff6d5a;
  --color-btn-text: #fff;
  --radius: 6px;
  --container-width: 440px;
}
body {
  font-family: var(--font-family);
  background-color: var(--color-background);
  display: flex;
  justify-content: center;
  padding: 32px;
}
form {
  background: var(--color-card-bg);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px var(--color-card-shadow);
  padding: 24px;
  width: var(--container-width);
}
h1 {
  text-align: center;
  font-size: var(--font-size-header);
  color: var(--color-header);
  margin-bottom: 24px;
}
label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: var(--font-size-label);
}
input[type="text"],
input[type="tel"],
input[type="datetime-local"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 10px;
  font-size: var(--font-size-input);
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 16px;
  box-sizing: border-box;
}
input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--color-focus-border);
  box-shadow: 0 0 4px var(--color-focus-border);
}
textarea { resize: vertical; }
button[type="submit"] {
  background-color: var(--color-btn-bg);
  color: var(--color-btn-text);
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: var(--font-size-input);
  cursor: pointer;
  margin-bottom: 16px;
}
button[type="submit"]:hover { background-color: #e05343; }
.note { font-size: 13px; color: #555; margin: 4px 0 16px 0; line-height: 1.4; }
.small-checkbox-label { font-size: 13px; margin-left: 4px; }
#thankYouPopup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#thankYouPopup .popup-content {
  background: white;
  border-radius: 12px;
  padding: 24px 16px;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
#thankYouPopup .checkmark { font-size: 48px; color: #4CAF50; margin-bottom: 16px; }
#thankYouPopup h1 { font-size: 20px; margin-bottom: 12px; color: #222; }
#thankYouPopup p { font-size: 15px; color: #555; line-height: 1.6; margin: 0; }
#thankYouPopup button {
  margin-top: 20px;
  background-color: #ff6d5a;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}
#sameAsPickupWrapper { margin-bottom: 8px; }
.same-as-active { margin-bottom: 40px; }
</style>
</head>
<body>

<form id="appointmentForm" method="POST" action="https://risetotop.app.n8n.cloud/webhook-test/uw-admin" novalidate>
  <h1>Ultra Wash Appointment</h1>

  <!-- Form Type Selection -->
  <label for="formMode">Form Type</label>
  <select id="formMode" name="formMode" required>
    <option value="" disabled selected>Select Form Type</option>
    <option value="customer">Customer Form</option>
    <option value="update">Update Form</option>
  </select>

  <!-- Customer Form -->
  <div id="customerForm" style="display:none;">
    <label for="name">Full Name</label>
    <input id="name" name="name" type="text" placeholder="First Name, Last Name" />

    <label for="phone">Phone Number</label>
    <input id="phone" name="phone" type="tel" placeholder="+673 8221133 / 8221133" />

    <label for="service">Service</label>
    <select id="service" name="service">
      <option value="" disabled selected>Select service</option>
      <option value="Self Drop-off & Pick Up">Self Drop-off & Pick Up</option>
      <option value="Pick Up Only">Pick Up Only</option>
      <option value="Delivery Only">Delivery Only</option>
      <option value="Pick Up & Delivery">Pick Up & Delivery</option>
    </select>

    <div id="serviceFields" style="display:none;">
      <div id="singleAddressSection" style="display:none;">
        <label id="singleAddressLabel">Address</label>
        <textarea id="singleAddress" name="singleAddress" placeholder="Enter your Address" rows="3"></textarea>
        <label for="singleMapLink">Map Link</label>
        <input id="singleMapLink" name="singleMapLink" type="text" placeholder="Paste Google Maps link or Coordinates" />
        <label id="singleDateLabel">Date & Time</label>
        <div class="note" id="singleDateNote"></div>
        <input type="datetime-local" id="singleDateTime" name="singleDateTime" />
        <input type="hidden" id="singleDateFormatted" name="singleDateFormatted">
      </div>

      <div id="pickUpDeliverySection" style="display:none;">
        <label>Pick Up Location</label>
        <textarea id="pickupAddress" name="pickupAddress" placeholder="Enter your Address" rows="3"></textarea>
        <label for="pickupMapLink">Map Link</label>
        <input id="pickupMapLink" name="pickupMapLink" type="text" placeholder="Paste Google Maps link" />
        <label>Pick Up Date & Time</label>
        <div class="note">⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
        <input type="datetime-local" id="pickupDate" name="pickupDate" />
        <input type="hidden" id="pickupDateFormatted" name="pickupDateFormatted">

        <label>Delivery Location</label>
        <div id="sameAsPickupWrapper">
          <input type="checkbox" id="sameAsPickup"> 
          <span class="small-checkbox-label">Delivery address same as Pickup</span>
        </div>
        <textarea id="deliveryAddress" name="deliveryAddress" placeholder="Enter your Address" rows="3"></textarea>
        <label for="deliveryMapLink" id="deliveryMapLabel">Map Link</label>
        <input id="deliveryMapLink" name="deliveryMapLink" type="text" placeholder="Paste Google Maps link" />
        <div id="deliveryDateSection" style="display:none;">
          <label>Delivery Date & Time</label>
          <div class="note">⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
          <input type="datetime-local" id="deliveryDate" name="deliveryDate" />
          <input type="hidden" id="deliveryDateFormatted" name="deliveryDateFormatted">
        </div>
      </div>
    </div>
  </div>

  <!-- Update Form (Worker Form) -->
<div id="updateForm" style="display:none;">
  <label for="customerRef">Customer Reference (Phone/ID)</label>
  <select id="customerRef" name="customerRef" required>
    <option value="" disabled selected>Select Customer</option>
  </select>

  <label for="mapLinkWorker">Map Link</label>
  <input id="mapLinkWorker" name="mapLinkWorker" type="text" readonly placeholder="Auto-filled from Customer Data" />

  <label for="serviceWorker">Service Type</label>
  <input id="serviceWorker" name="serviceWorker" type="text" readonly placeholder="Auto-filled from Customer Data" />

  <!-- NEW: Customer Name -->
  <input id="customerNameWorker" name="customerNameWorker" type="hidden" />

  <label for="totalItems">Total Items</label>
  <input id="totalItems" name="totalItems" type="number" min="1" placeholder="Enter total items" />

  <label for="totalWeight">Total Weight (kg)</label>
  <input id="totalWeight" name="totalWeight" type="number" min="0" step="0.1" placeholder="Enter total weight" />
</div>

  <button type="submit">Submit</button>
</form>

<div id="thankYouPopup">
  <div class="popup-content">
    <div class="checkmark">✅</div>
    <h1>Thank you for choosing UltraWash!</h1>
    <p>Your appointment has been successfully submitted.<br>Our team will contact you shortly via WhatsApp.</p>
    <button onclick="closePopup()">Close</button>
  </div>
</div>

<script>
const formMode = document.getElementById('formMode');
const customerForm = document.getElementById('customerForm');
const updateForm = document.getElementById('updateForm');
const serviceSelect = document.getElementById('service');
const serviceFields = document.getElementById('serviceFields');
const singleAddressSection = document.getElementById('singleAddressSection');
const pickUpDeliverySection = document.getElementById('pickUpDeliverySection');
const sameAsPickup = document.getElementById('sameAsPickup');
const sameAsPickupWrapper = document.getElementById('sameAsPickupWrapper');
const deliveryAddress = document.getElementById('deliveryAddress');
const deliveryMapLink = document.getElementById('deliveryMapLink');
const deliveryMapLabel = document.getElementById('deliveryMapLabel');

// Switch form modes
formMode.addEventListener('change', () => {
  if(formMode.value === 'customer'){
    customerForm.style.display = 'block';
    updateForm.style.display = 'none';
    serviceFields.style.display = 'none';
  } else if(formMode.value === 'update'){
    customerForm.style.display = 'none';
    updateForm.style.display = 'block';
  }
});

// Service selection
serviceSelect.addEventListener('change', () => {
  serviceFields.style.display = 'block';
  if(serviceSelect.value === 'Self Drop-off & Pick Up'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'none';
  } else if(serviceSelect.value === 'Pick Up Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Pick Up Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Delivery Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Delivery Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Pick Up & Delivery'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'block';
    sameAsPickup.checked = false;
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Delivery same as pickup toggle
sameAsPickup.addEventListener('change', () => {
  if(sameAsPickup.checked){
    deliveryAddress.style.display = 'none';
    deliveryMapLink.style.display = 'none';
    deliveryMapLabel.style.display = 'none';
    document.getElementById('deliveryDateSection').style.display = 'none';
    sameAsPickupWrapper.classList.add('same-as-active');
  } else {
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Close popup
function closePopup(){ document.getElementById('thankYouPopup').style.display='none'; }

// Load customer list from Google Apps Script
async function loadCustomers() {
  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec");
    const customers = await response.json();
    const customerRefSelect = document.getElementById("customerRef");

    customers.forEach(cust => {
      let option = document.createElement("option");
      option.value = cust["Customer ID"] || cust["Phone"];
      option.textContent = `${cust["Name"]} (${cust["Customer ID"]})`;
      option.dataset.maplink = cust["Map Link / Coordinates"];
      option.dataset.address = cust["Location Address"];
      option.dataset.service = cust["Service Type"] || ""; // <-- Service Type
      customerRefSelect.appendChild(option);
    });

    customerRefSelect.addEventListener("change", function() {
  const selectedOption = this.options[this.selectedIndex];
  document.getElementById("mapLinkWorker").value = selectedOption.dataset.maplink || "";
  document.getElementById("serviceWorker").value = selectedOption.dataset.service || "";
  
  // Auto-fill hidden customer name
  document.getElementById("customerNameWorker").value = selectedOption.textContent || "";
});

  } catch (err) {
    console.error("Error loading customers:", err);
  }
}
window.addEventListener("DOMContentLoaded", loadCustomers);

// Function to get Brunei formatted date/time
function getBruneiFormattedDateTime(inputId) {
  const dt = document.getElementById(inputId).valueAsDate || new Date();
  return dt.toLocaleString("en-US", {
    timeZone: "Asia/Brunei",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  });
}

// Submit handler
document.getElementById('appointmentForm').addEventListener('submit', async function(e){
  e.preventDefault();

  // Fill hidden formatted fields
  document.getElementById('singleDateFormatted').value = getBruneiFormattedDateTime('singleDateTime');
  document.getElementById('pickupDateFormatted').value = getBruneiFormattedDateTime('pickupDate');
  document.getElementById('deliveryDateFormatted').value = getBruneiFormattedDateTime('deliveryDate');

  const formData = new FormData(this);

  try {
    const response = await fetch(this.action, { method: this.method, body: formData });
    if(response.ok){
      document.getElementById('thankYouPopup').style.display = 'flex';
      this.reset();
      serviceFields.style.display = 'none';
      singleAddressSection.style.display = 'none';
      pickUpDeliverySection.style.display = 'none';
      document.getElementById('deliveryDateSection').style.display = 'none';

      // REMOVE selected customer from the Update Form dropdown
      if(formMode.value === 'update'){
        const customerSelect = document.getElementById('customerRef');
        const selectedIndex = customerSelect.selectedIndex;
        if(selectedIndex > 0){ // ignore the placeholder option
          customerSelect.remove(selectedIndex);
        }
        // Reset to placeholder
        customerSelect.selectedIndex = 0;
        document.getElementById('mapLinkWorker').value = ""; 
        document.getElementById('serviceWorker').value = ""; // clear service field
      }

    } else { 
      alert('Error submitting the form. Please try again.'); 
    }
  } catch(err){
    alert('Error submitting the form. Check your internet connection.');
    console.error(err);
  }
});
</script>

</body>
</html>
